<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanIt - Group Scheduling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .cell-hover:hover { filter: brightness(95%); cursor: pointer; }
        .selected-place { border: 2px solid black; transform: scale(1.05); }
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col relative max-w-7xl mx-auto w-full bg-white shadow-xl h-full">
        
        <!-- HEADER -->
        <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center z-10">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.hash=''">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-calendar-days"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-gray-900">PlanIt</h1>
            </div>
            <div id="header-actions" class="flex gap-2">
                <!-- Dynamic Buttons injected here -->
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="main-content" class="flex-1 overflow-hidden relative">
            <!-- Views will be injected here via JS -->
            <div id="loading-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-50">
                <div class="loader mb-4"></div>
                <p class="text-gray-500">Connecting to scheduler...</p>
            </div>
        </main>

    </div>

    <!-- MODAL (Name Entry) -->
    <div id="name-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-2">Who are you?</h2>
            <p class="text-gray-500 mb-4">Enter your name so others know who is planning.</p>
            <input type="text" id="username-input" class="w-full border border-gray-300 p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. Alex">
            <button onclick="saveName()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Join Schedule</button>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        // TODO: REPLACE THIS WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyBsAeABlr_WtDwGgrYQJWSEYPnsERpN8kQ",
          authDomain: "planit-8962e.firebaseapp.com",
          projectId: "planit-8962e",
          storageBucket: "planit-8962e.firebasestorage.app",
          messagingSenderId: "796305375372",
          appId: "1:796305375372:web:4e7af1f6be01a2f507fba9",
          measurementId: "G-J19F59WR92"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let currentGroupId = null;
        let groupData = null;
        let unsubscribeGroup = null;
        let selectedPlace = null; // Currently selected tool/place
        
        // Use a fixed App ID for the path to ensure consistency
        const APP_ID = 'planit-scheduler-v1';

        // --- 2. AUTHENTICATION & INIT ---
        async function initApp() {
            try {
                // Anonymous Auth (Required for Firestore Rules)
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        // Check URL hash to see if we are joining a group
                        handleRouting();
                    }
                });
            } catch (error) {
                console.error("Auth Error:", error);
                alert("Could not connect to database. Check console.");
            }
        }

        // --- 3. ROUTING ---
        function handleRouting() {
            const hash = window.location.hash.substring(1); // Remove #
            if (hash.startsWith('group/')) {
                const groupId = hash.split('/')[1];
                loadGroupView(groupId);
            } else {
                loadLandingView();
            }
        }

        window.addEventListener('hashchange', handleRouting);

        // --- 4. VIEWS ---

        // LANDING PAGE
        function loadLandingView() {
            if (unsubscribeGroup) unsubscribeGroup(); // Stop listening to old group
            currentGroupId = null;
            
            const html = `
                <div class="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-blue-50 to-indigo-50">
                    <div class="max-w-lg w-full text-center space-y-8">
                        <div>
                            <h2 class="text-4xl font-extrabold text-gray-900 mb-2">Coordinate Simply.</h2>
                            <p class="text-lg text-gray-600">Create a group, share the link, and see where everyone is.</p>
                        </div>
                        
                        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                            <label class="block text-left text-sm font-medium text-gray-700 mb-2">Group Name</label>
                            <input type="text" id="new-group-name" 
                                class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-4 mb-6" 
                                placeholder="e.g. Berlin Trip, Office Schedule">
                            
                            <button onclick="window.createGroup()" 
                                class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-xl text-lg px-5 py-4 text-center transition shadow-lg shadow-blue-500/30">
                                Create New Group
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('header-actions').innerHTML = '';
        }

        // GROUP SCHEDULER PAGE
        function loadGroupView(groupId) {
            currentGroupId = groupId;
            document.getElementById('loading-screen').classList.remove('hidden');

            // Listen to the document
            const groupRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'groups', groupId);
            
            unsubscribeGroup = onSnapshot(groupRef, (docSnap) => {
                document.getElementById('loading-screen').classList.add('hidden');
                
                if (docSnap.exists()) {
                    groupData = docSnap.data();
                    renderScheduler();
                    checkUserName(); // Ask for name if not set
                } else {
                    document.getElementById('main-content').innerHTML = `<div class="p-10 text-center text-red-500">Group not found.</div>`;
                }
            }, (error) => {
                console.error("Snapshot error:", error);
                document.getElementById('main-content').innerHTML = `<div class="p-10 text-center text-red-500">Error loading data.</div>`;
            });
        }

        // --- 5. LOGIC & ACTIONS ---

        // Create Group
        window.createGroup = async () => {
            const name = document.getElementById('new-group-name').value;
            if (!name) return alert("Please enter a group name");

            const newGroupId = 'g-' + Math.random().toString(36).substr(2, 9);
            
            // Default Places
            const defaultPlaces = [
                { id: 'p1', name: 'Office', color: 'bg-blue-100 text-blue-800 border-blue-200' },
                { id: 'p2', name: 'Home', color: 'bg-green-100 text-green-800 border-green-200' },
                { id: 'p3', name: 'Away', color: 'bg-orange-100 text-orange-800 border-orange-200' }
            ];

            try {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'groups', newGroupId), {
                    name: name,
                    createdAt: new Date().toISOString(),
                    places: defaultPlaces,
                    users: {}, // Map of userId -> { name: "John" }
                    schedule: {} // Map of "userId_date" -> placeId
                });
                
                window.location.hash = `group/${newGroupId}`;
            } catch (e) {
                console.error(e);
                alert("Error creating group. Check config.");
            }
        };

        // User Name Logic
        function checkUserName() {
            const storedName = localStorage.getItem('planit_username');
            if (!storedName) {
                document.getElementById('name-modal').classList.remove('hidden');
            } else {
                // Ensure user is registered in the group doc
                registerUserInGroup(storedName);
            }
        }

        window.saveName = () => {
            const name = document.getElementById('username-input').value;
            if (!name) return;
            localStorage.setItem('planit_username', name);
            document.getElementById('name-modal').classList.add('hidden');
            registerUserInGroup(name);
        }

        async function registerUserInGroup(name) {
            if (!currentUser || !currentGroupId) return;
            
            // Check if already registered to avoid unnecessary writes
            if (groupData.users && groupData.users[currentUser.uid] && groupData.users[currentUser.uid].name === name) return;

            const groupRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'groups', currentGroupId);
            await updateDoc(groupRef, {
                [`users.${currentUser.uid}`]: { name: name }
            });
        }

        // Add Place
        window.addPlace = async () => {
            const name = prompt("Enter name for new place:");
            if (!name) return;
            
            const colors = [
                'bg-purple-100 text-purple-800 border-purple-200',
                'bg-pink-100 text-pink-800 border-pink-200',
                'bg-yellow-100 text-yellow-800 border-yellow-200',
                'bg-teal-100 text-teal-800 border-teal-200'
            ];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            const newPlace = {
                id: 'p-' + Date.now(),
                name: name,
                color: randomColor
            };

            const groupRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'groups', currentGroupId);
            await updateDoc(groupRef, {
                places: arrayUnion(newPlace)
            });
        }

        // Copy Link
        window.copyLink = () => {
            const url = window.location.href;
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy'); // Fallback for iframe restrictions
            document.body.removeChild(textarea);
            alert("Link copied to clipboard! Send it to your group.");
        }

        // Select Tool/Place
        window.selectPlace = (placeId) => {
            selectedPlace = placeId;
            renderScheduler(); // Re-render to show selection state
        }

        // Update Schedule Cell
        window.toggleCell = async (dateStr) => {
            if (!currentUser) return;
            
            // If no tool selected, do nothing or clear? Let's assume toggle requires selection
            // Or if clicked same cell, clear it.
            
            const key = `${currentUser.uid}_${dateStr}`;
            const currentVal = groupData.schedule ? groupData.schedule[key] : null;
            
            let newVal = selectedPlace;
            
            // If clicking with same tool, clear it (toggle off)
            if (currentVal === selectedPlace) {
                newVal = null; 
            } else if (!selectedPlace) {
                // If no place selected, maybe treat as eraser?
                // For UX simplicity: if nothing selected, do nothing, alert user
                alert("Select a place from the top bar first!");
                return;
            }

            // Optimistic update (UI will flicker if we wait for server, but simple is better here)
            // Actually, Firestore listener is fast. Let's just write.
            
            const groupRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'groups', currentGroupId);
            
            // Use FieldValue.delete() if null, but updateDoc with dot notation requires importing deleteField
            // Simpler: Just set it to null or empty string.
            // Using a plain object merge
            
            const updatePayload = {};
            // If we want to delete, we technically need deleteField(), but setting to null is fine for logic
            // We will just filter nulls in render
            if (newVal === null) {
                // Firestore deleteField is tricky in vanilla module import without explicit import
                // Let's import it dynamically or just set to "CLEARED"
                 updatePayload[`schedule.${key}`] = "CLEARED";
            } else {
                updatePayload[`schedule.${key}`] = newVal;
            }

            await updateDoc(groupRef, updatePayload);
        }

        // --- 6. RENDERING ---
        
        function getDates() {
            const dates = [];
            const today = new Date();
            // Show last 2 days and next 12 days
            for(let i=-2; i<12; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function renderScheduler() {
            if (!groupData) return;

            // Header Actions
            const actionsDiv = document.getElementById('header-actions');
            actionsDiv.innerHTML = `
                <button onclick="window.copyLink()" class="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg hover:bg-indigo-200 transition font-medium text-sm">
                    <i class="fa-solid fa-link"></i> <span>Invite</span>
                </button>
            `;

            const dates = getDates();
            const users = groupData.users || {};
            const userIds = Object.keys(users);
            const schedule = groupData.schedule || {};
            const places = groupData.places || [];

            // Ensure current user is in the list even if not saved yet (optimistic)
            if (currentUser && !userIds.includes(currentUser.uid)) {
                userIds.push(currentUser.uid);
                users[currentUser.uid] = { name: localStorage.getItem('planit_username') || "You" };
            }

            let html = `
                <div class="flex flex-col h-full">
                    <!-- TOOLBAR (Places) -->
                    <div class="bg-white border-b border-gray-200 p-4 flex gap-3 overflow-x-auto no-scrollbar items-center">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mr-2">I am at:</span>
                        ${places.map(p => `
                            <button onclick="window.selectPlace('${p.id}')" 
                                class="${p.color} px-4 py-2 rounded-full border text-sm font-semibold whitespace-nowrap transition-all ${selectedPlace === p.id ? 'ring-2 ring-offset-2 ring-gray-400 scale-105 shadow-md' : 'opacity-70 hover:opacity-100'}">
                                ${p.name}
                            </button>
                        `).join('')}
                        
                        <button onclick="window.addPlace()" class="w-8 h-8 flex items-center justify-center rounded-full border border-dashed border-gray-400 text-gray-400 hover:text-blue-500 hover:border-blue-500 transition">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        
                        <div class="ml-auto text-sm text-gray-500 hidden md:block">
                            Select a place, then tap the grid.
                        </div>
                    </div>

                    <!-- GRID -->
                    <div class="flex-1 overflow-auto bg-gray-50 p-4">
                        <div class="inline-block min-w-full bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            
                            <!-- Header Row (Dates) -->
                            <div class="flex border-b border-gray-200">
                                <div class="w-32 md:w-48 p-3 flex-shrink-0 bg-gray-50 border-r border-gray-200 font-bold text-gray-500 text-sm flex items-center">
                                    Team Member
                                </div>
                                ${dates.map(d => {
                                    const isToday = d.toDateString() === new Date().toDateString();
                                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                                    return `
                                    <div class="w-20 md:w-24 p-2 flex-shrink-0 text-center border-r border-gray-100 ${isToday ? 'bg-blue-50' : ''} ${isWeekend ? 'bg-gray-50' : ''}">
                                        <div class="text-xs text-gray-400 uppercase font-bold">${d.toLocaleDateString('en-US', {weekday: 'short'})}</div>
                                        <div class="text-sm font-bold text-gray-700 ${isToday ? 'text-blue-600' : ''}">${d.getDate()}</div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>

                            <!-- User Rows -->
                            ${userIds.map(uid => {
                                const user = users[uid];
                                const isMe = currentUser && currentUser.uid === uid;
                                
                                return `
                                <div class="flex border-b border-gray-100 hover:bg-gray-50 transition-colors group">
                                    <!-- User Name Column -->
                                    <div class="w-32 md:w-48 p-3 flex-shrink-0 border-r border-gray-200 flex items-center bg-white z-10 sticky left-0 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-gray-200 to-gray-300 flex items-center justify-center text-gray-600 font-bold text-xs mr-3">
                                            ${user.name.charAt(0).toUpperCase()}
                                        </div>
                                        <div class="truncate">
                                            <div class="text-sm font-medium text-gray-900 truncate">${user.name} ${isMe ? '<span class="text-xs text-blue-500 bg-blue-50 px-1 rounded ml-1">(You)</span>' : ''}</div>
                                        </div>
                                    </div>

                                    <!-- Date Cells -->
                                    ${dates.map(d => {
                                        const dateKey = formatDateKey(d);
                                        const schedKey = `${uid}_${dateKey}`;
                                        const placeId = schedule[schedKey];
                                        const place = (placeId && placeId !== 'CLEARED') ? places.find(p => p.id === placeId) : null;
                                        
                                        // Only I can edit my row
                                        const isEditable = isMe;
                                        const isToday = d.toDateString() === new Date().toDateString();
                                        
                                        return `
                                        <div onclick="${isEditable ? `window.toggleCell('${dateKey}')` : ''}" 
                                            class="w-20 md:w-24 h-14 md:h-16 flex-shrink-0 border-r border-gray-100 border-dotted relative flex items-center justify-center transition-all
                                                ${isEditable ? 'cursor-pointer hover:bg-gray-100' : 'cursor-default'}
                                                ${isToday ? 'bg-blue-50/30' : ''}
                                            ">
                                            
                                            ${place ? `
                                                <div class="${place.color} text-xs font-semibold px-2 py-1 rounded shadow-sm max-w-[90%] truncate text-center select-none pointer-events-none transform transition-transform group-hover:scale-105">
                                                    ${place.name}
                                                </div>
                                            ` : `
                                                ${isEditable ? '<div class="opacity-0 hover:opacity-100 text-gray-300 text-xl">+</div>' : ''}
                                            `}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                                `;
                            }).join('')}

                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        // Start
        initApp();

    </script>
</body>
</html>
